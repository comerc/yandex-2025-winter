# Обоснование решения задачи "Последние приготовления"

## Математическая модель

### Манхэттенское расстояние

Манхэттенское расстояние между точками `(x1, y1)` и `(x2, y2)` определяется как:

```
d = |x1 - x2| + |y1 - y2|
```

### Сумма расстояний

После каждой команды нужно вычислить сумму манхэттенских расстояний от текущей позиции Кодеруна `(cx, cy)` до всех N меток `(mx_i, my_i)`:

```
sum = Σ_{i=1}^{N} (|cx - mx_i| + |cy - my_i|)
```

Это можно разложить на сумму по координатам:

```
sum = Σ_{i=1}^{N} |cx - mx_i| + Σ_{i=1}^{N} |cy - my_i|
```

### Оптимизация вычисления суммы модулей

Для вычисления `Σ |cx - mx_i|` можно использовать сортировку и префиксные суммы.

Если отсортировать метки по координате x, то для заданного `cx`:

- Метки с `mx_i ≤ cx`: вклад = `cx - mx_i`
- Метки с `mx_i > cx`: вклад = `mx_i - cx`

Используя бинарный поиск, находим индекс `idx`, такой что `sortedX[0..idx-1] ≤ cx` и `sortedX[idx..N-1] > cx`.

Тогда:

```
Σ |cx - mx_i| = cx × idx - Σ_{i=0}^{idx-1} sortedX[i] + Σ_{i=idx}^{N-1} sortedX[i] - cx × (N - idx)
```

С префиксными суммами `prefixSum[k] = Σ_{i=0}^{k-1} sortedX[i]`:

```
Σ |cx - mx_i| = cx × idx - prefixSum[idx] + (prefixSum[N] - prefixSum[idx]) - cx × (N - idx)
              = cx × (2×idx - N) + prefixSum[N] - 2×prefixSum[idx]
```

Аналогично для координаты y.

## Алгоритм

1. **Чтение данных:** N меток и M команд
2. **Сортировка:** Сортируем метки по x и по y отдельно
3. **Префиксные суммы:** Предвычисляем префиксные суммы для отсортированных координат
4. **Обработка команд:**
   - Обновляем текущую позицию `(cx, cy)`
   - Для каждой координаты используем бинарный поиск для нахождения границы
   - Вычисляем сумму расстояний по формуле выше
   - Выводим результат

## Сложность алгоритма

### Временная сложность

- **Сортировка:** O(N log N) для x и O(N log N) для y
- **Префиксные суммы:** O(N)
- **Обработка одной команды:** O(log N) (бинарный поиск)
- **Обработка всех команд:** O(M log N)
- **Итого:** O(N log N + M log N)

Для максимальных ограничений:

- N = 100,000: сортировка ~1.3×10^6 операций
- M = 300,000: обработка команд ~5×10^6 операций
- **Всего:** ~6.3×10^6 операций — укладывается в лимит 3 секунды

### Пространственная сложность

- **Метки:** O(N) для x и O(N) для y
- **Отсортированные массивы:** O(N) для x и O(N) для y
- **Префиксные суммы:** O(N) для x и O(N) для y
- **Итого:** O(N) ≈ 800,000 байт (100,000 × 8 байт × 4 массива) ≈ 3.2 МБ

Это намного меньше лимита 512 МБ.

## Результаты бенчмарков

| Операция                                       | Время   |
| ---------------------------------------------- | ------- |
| Один запрос (бинарный поиск + вычисление)      | ~39 нс  |
| Полное решение (100,000 меток, 300,000 команд) | ~386 мс |

## Ключевые оптимизации

1. **Разделение координат:** Вычисляем сумму по x и y отдельно, что позволяет использовать сортировку
2. **Бинарный поиск:** O(log N) вместо O(N) для нахождения границы
3. **Префиксные суммы:** O(1) доступ к сумме элементов до заданного индекса
4. **Предвычисление:** Сортировка и префиксные суммы вычисляются один раз в начале

## Альтернативные подходы

### 1. Наивный подход O(N×M)

Для каждой команды перебираем все метки:

```go
for each command:
    for each marker:
        sum += |cx - mx| + |cy - my|
```

Сложность: O(N×M) = O(30×10^9) операций — слишком медленно.

### 2. Динамическое обновление

Можно попытаться обновлять сумму инкрементально при изменении позиции, но это сложно из-за модулей.

### 3. Координатная компрессия

Можно использовать координатную компрессию для уменьшения диапазона координат, но это не даёт значительного выигрыша при текущих ограничениях.

## Вывод

Использование сортировки и префиксных сумм с бинарным поиском даёт оптимальное решение с временной сложностью O(N log N + M log N) и пространственной сложностью O(N), что укладывается в заданные ограничения.
